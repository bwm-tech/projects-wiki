# __Payment Service__ (Подписочный сервис для lions-credit.ru)

[На главную](/README.md)

---

## Main Service

Стэк: __NestJS__, __Typescript__, __PostgreSQL__, __TypeORM__

Этот сервис отвечает только за регистрацию пользователей в системе, и привязку их карт и первое списание (происходит в течении 5 минут после успешной привязки карты). Структура проекта идентична остальным прродуктам реализованным нашим подразделением на NestJS.

---
## Cron Service

Стэк: __Go__, __PostgreSQL__

Сервис рекуррентных платежей на Go. Работает на системном (линуксовом) кроне. График запуска в кроне раз в сутки. Сервис запускается, получает из базы все активные карты и проверяет даты списаний. Если дата списания у карты совпадает с текущей датой сервис создается транзакция в базе с статусом __Waiting__ и осуществляется автоплатеж с карты. При успешном платеже статус транзакции меняется на __Success__. Платеж может быть отклонен эквайринг-сервисом. В таком случае статус меняется на __Rejected__. Статус __Failed__ назначается если у пользователя не достаточно средств на карте

### График автоплатежей следующий:

Списания с активных карт происходят раз в 5 дней. Если на момент списания у пользователя нет нужной суммы, сервис уменьшает сумму списания на половину от изначальной, назначает списание на следующие сутки и увеличивает количество недачных списаний по карте.

>При достижении трех неудачных списаний карта помечается неактивной.

---

### Репозитории на Github:  
[__Main Service__](https://github.com/bwm-tech/payment-service-main)  
[__Cron Service__](https://github.com/bwm-tech/payment-service-cron)
